<aura:component controller="TaxExemptionController" implements="flexipage:availableForRecordHome,force:hasRecordId,force:lightningQuickActionWithoutHeader" access="global" >
    <aura:attribute name="recordId" type="string"/>
    <aura:attribute name="spinner" type="boolean" default = "false"/> 
    <aura:attribute name="listOfRecords" type="list"/>
    <aura:attribute name="hasSelectedItem" type="boolean" default = "false"/> 
    <aura:attribute name="errMsg" type="string" default=""/>
    <aura:attribute name="fileName" type="String" default="No File Selected.." />
    <aura:attribute name="fileData" type="blob" default="" />
    
    <aura:attribute name="sortAsc" type="boolean" default="false"/>
    <aura:attribute name="selectedTabsoft" type="string" default="duration" description="Use for show/hide arraow sign on header based on conditions"/>
    <aura:attribute name="arrowDirection" type="string" default="arrowup" description="Use for change arrow sign direction on header based on click"/>
    
    <aura:attribute name="exeAmount" type="decimal" default=""/>
    <aura:attribute name="validFrom" type="date" default=""/>
    
    <aura:attribute name="PaginationList" type="list"/> 
    <aura:attribute name="selectedCount" type="integer" default="0"
                    description="selected Records Count"/>
    <aura:attribute name="startPage" type="Integer" />
    <aura:attribute name="endPage" type="Integer"/>
    <aura:attribute name="totalRecordsCount" type="Integer"/>
    <aura:attribute name="pageSize" type="Integer" default="5"
                    description="number of records to be display on per page"/>
    <aura:attribute name="currentPage" type="integer" default="1"/>
    <aura:attribute name="totalPagesCount" type="integer"/>
    <aura:attribute name="currentPageNumber" type="Integer" default="1"/>
    <aura:attribute name="totalPages" type="Integer" default="0"/>
    <aura:attribute name="pageList" type="List"/>   
    
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    
    
    <aura:html tag="style">
        .cuf-content {
        padding: 0 0rem !important;
        }
        .slds-modal__container{
        max-width: 80rem !important;
        width:80% !important;
        }
        .slds-p-around--medium {
        padding: 0rem !important;
        }       
        .slds-modal__content{
        overflow-y: hidden !important;
        height:unset !important;
        max-height:unset !important;
        }
    </aura:html>
    
        <article class="slds-card" style="">
            <div class="slds-page-header" role="banner" style="height: 50px;">
            <span style="display:inline-block; ">
                <h2>  <lightning:icon iconName="custom:custom17" size="small"/>
                    &nbsp;<b>Tax Exemptions ({!v.listOfRecords.length})</b>
                </h2>
            </span>
            <span class="" style="display:inline-block; float:right; width: 33%;">
                <div class="slds-grid">
                    <div class="slds-col slds-size_1-of-2 slds-p-around_xx-small slds-align_absolute-center">
                        <Lightning:input aura:id="vfDate" placeholder="Valid From Date" variant="label-hidden" onchange="{!c.updateAllValidFromDate}"  type="date" /> 
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_xx-small slds-align_absolute-center">
                        <lightning:input aura:id="eAmount" formatter="percent-fixed" variant="label-hidden"  placeholder="Exemption Amount %" type="number"  min="0" max="100" value="" onchange="{!c.updateAllExeAmount}" step="0.01"/>
                    </div>
                </div>
            </span>
        </div>
            <div style="background-color:white;" class="slds-card__body slds-card__body_inner">
                <!-- lightning:button to get selected rows data -->
               
            </div>
                <aura:if isTrue="{!v.spinner}">
                    <div aura:id="spinnerId" class="slds-spinner_container">
                        <div class="slds-spinner--brand  slds-spinner slds-spinner--large slds-is-relative" role="alert">
                            <span class="slds-assistive-text">Loading...</span>
                            <div class="slds-spinner__dot-a"></div>
                            <div class="slds-spinner__dot-b"></div>
                        </div>
                    </div>
                </aura:if>
                <div class="slds-p-around_xx-small">
                    <div class="slds-table--header-fixed_container" style="height:350px; width:100%">
                        <div class="slds-scrollable_y" style="height:80%;background-color: white;">
                            <table class="slds-table slds-table_bordered slds-table--header-fixed">
                                <thead>
                                    <tr >
                                        <!--header checkbox for select all-->
                                        <th style="width:0%;" scope="col" class="slds-text-align_right">
                                            <div class="slds-truncate slds-cell-fixed" style="padding-left: 8px;padding-top: 8px;">
                                                <div class="slds-form-element__control">
                                                    <label class="slds-checkbox">
                                                         <ui:inputCheckbox value="false"
                                          change="{!c.checkboxSelectAll}"/>
                                                        <span class="slds-checkbox_faux"></span>
                                                        <span class="slds-form-element__label"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </th>
                                        <th style="width:20%;" class="slds-is-sortable " scope="col" onclick="{!c.sortByUANumber}">
                                            <div class="slds-truncate slds-cell-fixed" style="padding-top: 7px;padding-left: 8px;">
                                                <a href="javascript:void(0);" class="slds-text-link--reset">
                                                    <span class="slds-assistive-text">Sort</span>
                                                    <span class="slds-truncate" title="Utility Account Number">Utility Account Number</span>  
                                                    <aura:if isTrue="{! and(v.arrowDirection == 'arrowdown', v.selectedTabsoft == 'UANumber') }">&nbsp;  &#9660; </aura:if>  
                                                    <aura:if isTrue="{! and(v.arrowDirection != 'arrowdown', v.selectedTabsoft == 'UANumber') }"> &nbsp;  &#9650; </aura:if>                        
                                                </a>
                                            </div>
                                        </th>
                                        <th style="width:45%;" class="slds-is-sortable" scope="col" >
                                            <div class="slds-truncate slds-cell-fixed" style="padding-top: 7px;padding-left: 5px;width: 43%;">
                                                <div class="slds-align_absolute-center slds-border_bottom">
                                                    Existing
                                                </div>
                                                <div class="slds-grid slds-align_absolute-center">
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center">
                                                       Valid From
                                                   </div>
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center ">
                                                       Valid To
                                                   </div>
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center">
                                                       Exemption Amount
                                                   </div>
                                                </div>
                                            </div>
                                        </th>
                                         <th style="width:35%;" class="slds-is-sortable" scope="col" >
                                                                                       <div class="slds-truncate slds-cell-fixed" style="padding-top: 7px;padding-left: 5px;width: 33%;">
                                                <div class="slds-align_absolute-center slds-border_bottom">
                                                    New
                                                </div>
                                                <div class="slds-grid slds-align_absolute-center">
                                                   <div class="slds-col slds-size_1-of-2 slds-align_absolute-center">
                                                       Valid From
                                                   </div>
                                                    <div class="slds-col slds-size_1-of-2 slds-align_absolute-center">
                                                       Exemption Amount
                                                   </div>
                                                </div>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <aura:iteration items="{!v.PaginationList}" var="item" indexVar="index">
                                        <tr>
                                            <td scope="row" class="" style="width:0%;">
                                                <div class="slds-form-element">
                                                    <div class="slds-form-element__control">
                                                        <label class="slds-checkbox">
                                                             <ui:inputCheckbox 
                                                  name="{!index}"
                                                  value="{!item.isChecked}"
                                                  change="{!c.checkboxSelect}"/>
                                                            <span class="slds-checkbox_faux"></span>
                                                            <span class="slds-form-element__label text"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                            <td  style="width:20%;" scope="row">
                                                <div class="slds-truncate" title="{!item.UA.Name}">
                                                    <a href="{!'/one/one.app?#/sObject/'+ item.UA.Id + '/view'}" target="_blank">  {!item.UA.Name}</a>
                                                </div>
                                            </td>
                                            <td  style="width:45%;" scope="row">
                                                <div class="slds-grid">
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center">
                                                        <Lightning:formattedDateTime value="{!item.UATE.Valid_From__c}"/> 
                                                    </div>
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center">
                                                        <Lightning:formattedDateTime value="{!item.UATE.Valid_To__c}"/> 
                                                    </div>
                                                   <div class="slds-col slds-size_1-of-3 slds-align_absolute-center">
                                                        <Lightning:formattedNumber style="percent" value="{!item.UATE.Exemption_Amount__c/100 }"/> 
                                                    </div>
                                                </div>
                                            </td> 
                                            <td style="width:35%;" scope="row">
                                                <div class="slds-grid">
                                                   <div class="slds-col slds-size_1-of-2 slds-p-around_xx-small slds-align_absolute-center">
                                                        <lightning:input variant="label-hidden" type="date" name="{!index}" onchange="{!c.updateValidFromDate}" value="{!item.newValidFrom}"/>
                                                    </div>
                                                   <div class="slds-col slds-size_1-of-2 slds-p-around_xx-small slds-align_absolute-center">
                                                       <lightning:input formatter="percent-fixed" variant="label-hidden" onchange="{!c.updateExemptionAmount}" type="number" min="0" max="100" value="{!item.newExemptionAmount}" step="0.01"/>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </aura:iteration>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="slds-p-around_xx-small slds-align_absolute-center">
                        <lightning:input variant="label-hidden" name="file" type="file" multiple="false" accept=".pdf, .zip, .csv, .txt, .docx" aura:id="file" onchange="{! c.handleFilesChange }"/>
                    </div>
                    <div class="slds-text-body_small slds-align_absolute-center">{!v.fileName} </div>
                </div>
        </article>
        <footer class="slds-modal__footer" style="height:52px;">
            <lightning:layoutItem padding="around-small" flexibility="auto" class = "slds-align_absolute-center heightClass">
                <lightning:button label="First" iconName="utility:left" iconPosition="left"
                                  onclick="{!c.onFirst}" disabled="{! v.currentPageNumber == 1}"/>
                <lightning:button iconName="utility:chevronleft" iconPosition="left"
                                  onclick="{!c.onPrev}" disabled="{! v.currentPageNumber == 1}"/>
                <button value = "1"  onclick="{!c.onFirst}" disabled="{!item=='...'}" class="{!if(v.currentPageNumber==1,'slds-button slds-button_brand','slds-button slds-button_neutral')}"   data-record="1" name="1" onmousedown="{!c.currentPage}"   >
                    <ui:outputNumber value="1"/>
                </button>
                <aura:iteration items="{!v.pageList}" var="item">
                    <button value = "{!item}"  onclick="{!c.processMe}" disabled="{!item=='...'}" class="{!if(v.currentPageNumber==item,'slds-button slds-button_brand','slds-button slds-button_neutral')}"   data-record="{!num}" name="{!num}" onmousedown="{!c.currentPage}"   >
                        {!item}
                    </button>
                </aura:iteration>
                <aura:if isTrue = "{!and(v.totalPages != 0 , v.totalPages !=1)}">
                    <button value = "{!v.totalPages}"  onclick="{!c.onLast}" disabled="{!item=='...'}" class="{!if(v.currentPageNumber == v.totalPages,'slds-button slds-button_brand','slds-button slds-button_neutral')}"   data-record="{!v.totalPages}" name="{!v.totalPages}" onmousedown="{!c.currentPage}"   >
                        <ui:outputNumber value="{!v.totalPages}"/>
                    </button>
                </aura:if>
                <lightning:button iconName="utility:chevronright" iconPosition="right" 
                                  disabled="{! v.currentPageNumber == v.totalPages}" onclick="{!c.onNext}"/>
                <lightning:button label="Last" iconName="utility:right" iconPosition="right" 
                                  disabled="{! v.currentPageNumber == v.totalPages}" onclick="{!c.onLast}"/>
                <lightning:formattedText class = "slds-m-left--small slds-m-right--small " value="Show Records: " />
                <lightning:select class = "marginSelect" disabled="{!lessthanorequal(v.listOfRecords.length,5)}" required="false"  value = "{!v.pageSize}" onchange="{! c.changePageSize }">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="{!v.totalRecordsCount}">All</option>
                </lightning:select>
            </lightning:layoutItem>
            <span style="display:inline-block;float:right !important;margin-top:-27px !important;">
                <lightning:button variant="Brand" disabled="{!not(v.hasSelectedItem)}" class="slds-button" label="Finish" onclick="{!c.handleFinish}"/>
            </span>
        </footer>
</aura:component>